<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS Reading Simulator</title>
    <style>
        :root {
            --primary: #1a73e8;
            --bg: #f0f4ff;
            --text: #333;
            --card: #fff;
        }
        
        html, body {
            height: 100%;
            margin: 0;
            font-family: Inter, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            transition: background-color 0.3s, color 0.3s;
        }
        
        body.dark-mode {
            background: #0f1720;
            color: #e6eef8;
            --primary: #0d47a1;
            --bg: #121212;
            --text: #e0e0e0;
            --card: #1e1e1e;
        }
        
        header {
            background: var(--primary);
            color: #fff;
            padding: 12px 16px;
            font-size: 22px;
            text-align: center;
            font-weight: 700;
            transition: background-color 0.3s;
        }
        
        /* Layout */
        .container {
            height: calc(100% - 64px);
            display: flex;
            flex-direction: column;
        }
        
        .topbar {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            justify-content: space-between;
        }
        
        #uploadSection {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            margin: 18px;
        }
        
        .welcome {
            font-size: 20px;
            color: var(--primary);
            font-weight: 700;
            margin: 0;
        }
        
        .instruction {
            font-size: 16px;
            color: #555;
            margin: 0;
            transition: color 0.3s;
        }
        
        body.dark-mode .instruction {
            color: #9e9e9e;
        }
        
        #startBtn {
            padding: 10px 18px;
            font-size: 16px;
            border-radius: 10px;
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        #startBtn:hover {
            background: #1558b0;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        /* Viewers */
        #pdfArea {
            flex: 1;
            display: flex;
            gap: 8px;
            padding: 12px;
            box-sizing: border-box;
        }
        
        .pdf-viewer {
            flex: 1;
            border: 1px solid #d6dff5;
            background: var(--card);
            overflow: auto;
            position: relative;
            border-radius: 8px;
            padding: 8px;
            min-width: 200px;
            transition: background-color 0.3s, border-color 0.3s;
        }
        
        body.dark-mode .pdf-viewer {
            border-color: #444;
        }
        
        .pdf-viewer .canvas-wrap {
            transform-origin: 0 0;
            position: relative;
        }
        
        .pdf-viewer canvas {
            display: block;
            margin-bottom: 12px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
            border-radius: 4px;
        }
        
        /* Annotations */
        .text-annotation {
            position: absolute;
            color: #111;
            background: transparent;
            border: none;
            font-size: 16px;
            line-height: 1.3;
            min-height: 20px;
            resize: none;
            outline: none;
            padding: 2px;
            z-index: 55;
        }
        
        body.dark-mode .text-annotation {
            color: #e6eef8;
        }
        
        .highlight-area {
            position: absolute;
            background: rgba(255,235,59,0.28);
            z-index: 50;
            pointer-events: none;
            border-radius: 2px;
        }
        
        /* Controls */
        #timer {
            position: fixed;
            top: 14px;
            right: 18px;
            background: var(--primary);
            color: #fff;
            padding: 10px 14px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            z-index: 120;
            transition: background-color 0.3s;
        }
        
        #timer.small {
            padding: 6px 10px;
            font-size: 14px;
            border-radius: 8px;
        }
        
        #controls {
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: center;
            padding: 8px;
        }
        
        .btn {
            background: var(--primary);
            color: #fff;
            border: none;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background: #1558b0;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .btn.secondary {
            background: #f0f0f0;
            color: #111;
        }
        
        .btn.secondary:hover {
            background: #e0e0e0;
        }
        
        /* Zoom controls */
        .zoom-controls {
            position: fixed;
            left: 18px;
            bottom: 18px;
            background: var(--card);
            padding: 8px;
            border-radius: 10px;
            box-shadow: 0 6px 18px rgba(10,20,40,0.06);
            z-index: 120;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        
        body.dark-mode .zoom-controls {
            box-shadow: 0 6px 18px rgba(0,0,0,0.2);
        }
        
        .zoom-value {
            min-width: 54px;
            text-align: center;
            font-weight: 700;
        }
        
        /* Annotation tools */
        .tools-area {
            position: fixed;
            right: 18px;
            bottom: 18px;
            z-index: 120;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .annotation-tools {
            display: flex;
            flex-direction: column;
            gap: 6px;
            background: var(--card);
            padding: 8px;
            border-radius: 10px;
            box-shadow: 0 6px 18px rgba(10,20,40,0.06);
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        
        body.dark-mode .annotation-tools {
            box-shadow: 0 6px 18px rgba(0,0,0,0.2);
        }
        
        .annotation-btn {
            padding: 8px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            background: #f0f0f0;
            transition: all 0.3s;
        }
        
        body.dark-mode .annotation-btn {
            background: #444;
            color: #e0e0e0;
        }
        
        .annotation-btn:hover {
            background: #e0e0e0;
        }
        
        body.dark-mode .annotation-btn:hover {
            background: #555;
        }
        
        .annotation-btn.active {
            background: rgba(26,115,232,0.12);
            color: var(--primary);
        }
        
        /* History/end screen */
        #endTest {
            display: none;
            padding: 12px;
            gap: 12px;
            align-items: stretch;
            min-height: 200px;
        }
        
        #history {
            flex: 1;
            border: 1px solid #e4e9ff;
            padding: 12px;
            border-radius: 8px;
            overflow: auto;
            transition: border-color 0.3s;
        }
        
        body.dark-mode #history {
            border-color: #444;
        }
        
        #newTest {
            flex: 1;
            padding: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        /* Modal */
        .modal {
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%,-50%);
            background: var(--card);
            padding: 14px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(10,20,40,0.15);
            z-index: 1000;
            min-width: 260px;
            display: none;
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        
        body.dark-mode .modal {
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .modal.show {
            display: block;
        }
        
        .modal h3 {
            margin: 0 0 8px 0;
            font-size: 16px;
        }
        
        .time-inputs {
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
        }
        
        .time-inputs input {
            width: 64px;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #e6e9fc;
            text-align: center;
            font-weight: 700;
            font-size: 15px;
            background: var(--card);
            color: var(--text);
            transition: background-color 0.3s, border-color 0.3s;
        }
        
        body.dark-mode .time-inputs input {
            border-color: #555;
        }
        
        .modal .actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 8px;
        }
        
        /* Context menu */
        .context-menu {
            position: absolute;
            background: var(--card);
            border: 1px solid #ddd;
            border-radius: 6px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
            z-index: 9999;
            display: none;
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        
        body.dark-mode .context-menu {
            border-color: #555;
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }
        
        .context-menu-item {
            padding: 8px 12px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .context-menu-item:hover {
            background: #f3f7ff;
        }
        
        body.dark-mode .context-menu-item:hover {
            background: #333;
        }
        
        /* Dark mode toggle */
        .dark-mode-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #2196F3;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .toggle-label {
            position: absolute;
            left: 70px;
            top: 8px;
            color: #333;
            font-weight: bold;
            white-space: nowrap;
            transition: color 0.3s;
        }
        
        body.dark-mode .toggle-label {
            color: #e0e0e0;
        }
        
        /* Footer */
        footer {
            text-align: center;
            padding: 10px;
            color: #999;
            font-size: 14px;
            transition: color 0.3s;
        }
        
        body.dark-mode footer {
            color: #666;
        }
        
        /* Made by */
        #madeBy {
            text-align: center;
            margin: 10px;
            color: var(--primary);
            font-weight: bold;
            transition: color 0.3s;
        }
        
        /* Answer widget */
        .answer-widget {
            position: absolute;
            display: flex;
            gap: 4px;
            background: rgba(255,255,255,0.9);
            border: 1px solid #e6e9fc;
            padding: 4px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 13px;
            z-index: 60;
        }
        
        body.dark-mode .answer-widget {
            background: rgba(40,40,40,0.9);
            border-color: #555;
        }
        
        .answer-widget button {
            padding: 4px 8px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            background: #f2f6ff;
            font-weight: 700;
            font-size: 13px;
            transition: all 0.3s;
        }
        
        body.dark-mode .answer-widget button {
            background: #333;
            color: #e0e0e0;
        }
        
        .answer-widget button:hover {
            background: #e0e0e0;
        }
        
        body.dark-mode .answer-widget button:hover {
            background: #444;
        }
        
        /* Responsive */
        @media (max-width: 900px) {
            #pdfArea {
                flex-direction: column;
            }
            
            #timer {
                right: 12px;
                top: 70px;
            }
        }
    </style>
</head>
<body>
    <!-- Dark Mode Toggle -->
    <div class="dark-mode-toggle">
        <label class="toggle-switch">
            <input type="checkbox" id="darkModeToggle">
            <span class="slider"></span>
        </label>
        <span class="toggle-label">Dark Mode</span>
    </div>

    <header>IELTS Reading Simulator</header>

    <!-- Timer -->
    <div id="timer" title="Нажмите, чтобы задать время">00:00:00</div>

    <!-- Timer modal -->
    <div id="timerModal" class="modal" role="dialog" aria-modal="true">
        <h3>Настройка таймера</h3>
        <div class="time-inputs">
            <input id="hoursInput" type="number" min="0" max="99" placeholder="hh" />
            <span>:</span>
            <input id="minutesInput" type="number" min="0" max="59" placeholder="mm" />
            <span>:</span>
            <input id="secondsInput" type="number" min="0" max="59" placeholder="ss" />
        </div>
        <div class="actions">
            <button class="btn secondary" id="cancelTimerBtn">Отмена</button>
            <button class="btn" id="confirmTimerBtn">Старт</button>
        </div>
    </div>

    <div class="container">
        <div class="topbar">
            <div id="uploadSection">
                <input id="fileInput" type="file" accept="application/pdf" />
                <p class="welcome">Добро пожаловать на IELTS Reading Simulator</p>
                <p class="instruction">Загрузите ваш IELTS Reading PDF, чтобы начать</p>
                <div style="margin-top:8px;">
                    <button id="startBtn" class="btn" onclick="startTest()">Старт</button>
                </div>
            </div>

            <div id="controls" style="display:none;">
                <button id="endTestBtn" class="btn" onclick="endTestFunc()">Завершить тест</button>
                <button id="analyzeBtn" class="btn" style="background:#34a853" onclick="analyzeTest()">Режим: Анализ</button>
            </div>
        </div>

        <div id="pdfArea">
            <div class="pdf-viewer" id="pdfTextViewer">
                <div class="canvas-wrap" id="textCanvasWrap"></div>
            </div>

            <div class="pdf-viewer" id="pdfQuestionsViewer">
                <div style="padding:8px;color:#777">📝 Кликните по месту на правой колонке, чтобы добавить ответ (A/B/C/D) или заметку.</div>
                <div class="canvas-wrap" id="questionsCanvasWrap"></div>
            </div>
        </div>

        <!-- end test / history area -->
        <div id="endTest" style="display:none;">
            <div id="history">
                <h3>📜 Мои тесты</h3>
                <ul id="testHistory"></ul>
            </div>
            <div id="newTest">
                <h3>✅ Тест завершён!</h3>
                <div style="display:flex;gap:8px;">
                    <button class="btn" onclick="location.reload()">Начать новый тест</button>
                    <button class="btn secondary" onclick="analyzeTest()">Анализировать</button>
                </div>
            </div>
        </div>
    </div>

    <!-- zoom controls -->
    <div class="zoom-controls" id="zoomControls" style="display:none;">
        <button class="btn secondary" onclick="zoomOut()">−</button>
        <div class="zoom-value" id="zoomValue">100%</div>
        <button class="btn secondary" onclick="zoomIn()">+</button>
    </div>

    <!-- tools -->
    <div class="tools-area">
        <div class="annotation-tools" id="annotationTools" style="display:none;">
            <button class="annotation-btn" id="highlightToolBtn" onclick="toggleHighlightMode()">Хайлайт</button>
            <button class="annotation-btn" id="noteToolBtn" onclick="toggleNoteMode()">Заметка</button>
        </div>
    </div>

    <!-- context menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" id="ctxDelete">Удалить</div>
    </div>

    <!-- modal-ish small messages (kept simple) -->
    <div class="modal" id="messageModal" style="min-width:220px;display:none;">
        <div id="messageText"></div>
        <div style="text-align:right;margin-top:8px;"><button class="btn secondary" onclick="hideMessage()">OK</button></div>
    </div>

    <div id="madeBy">Made by Miraboss Mirzakhidov</div>
    <footer>&copy; 2025 IELTS Reading Simulator</footer>

    <!-- pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
    <script>
        /* ========= Global elements ========= */
        const fileInput = document.getElementById('fileInput');
        const pdfTextViewer = document.getElementById('pdfTextViewer');
        const pdfQuestionsViewer = document.getElementById('pdfQuestionsViewer');
        const textCanvasWrap = document.getElementById('textCanvasWrap');
        const questionsCanvasWrap = document.getElementById('questionsCanvasWrap');
        const timerEl = document.getElementById('timer');
        const timerModal = document.getElementById('timerModal');
        const hoursInput = document.getElementById('hoursInput');
        const minutesInput = document.getElementById('minutesInput');
        const secondsInput = document.getElementById('secondsInput');
        const confirmTimerBtn = document.getElementById('confirmTimerBtn');
        const cancelTimerBtn = document.getElementById('cancelTimerBtn');
        const zoomControls = document.getElementById('zoomControls');
        const zoomValueEl = document.getElementById('zoomValue');
        const annotationTools = document.getElementById('annotationTools');
        const highlightToolBtn = document.getElementById('highlightToolBtn');
        const noteToolBtn = document.getElementById('noteToolBtn');
        const contextMenu = document.getElementById('contextMenu');
        const ctxDelete = document.getElementById('ctxDelete');
        const controlsBar = document.getElementById('controls');
        const startBtn = document.getElementById('startBtn');
        const endTestEl = document.getElementById('endTest');
        const endTestBtn = document.getElementById('endTestBtn');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const testHistory = document.getElementById('testHistory');
        const darkModeToggle = document.getElementById('darkModeToggle');

        let pdfDoc = null;
        let currentPDFData = null;
        let currentScale = 1.0;
        const scaleStep = 0.1;
        const minScale = 0.5;
        const maxScale = 3.0;

        /* state */
        let isHighlighting = false;
        let isNoteMode = false;
        let currentHighlight = null;
        let highlights = []; // {el, containerId, left,top,w,h}
        let annotations = []; // {el, containerId, left,top, text}
        let answers = {}; // keyed by id -> {x,y,choice,containerId}
        let selectedCtxTarget = null;
        let countdown = null;
        let totalTime = 0; // seconds; default 0
        let timerRunning = false;
        let loadedFileName = '';

        /* localStorage keys */
        const LS_ANNOT = 'irs_annotations_v1';
        const LS_HL = 'irs_highlights_v1';
        const LS_ANS = 'irs_answers_v1';
        const LS_HISTORY = 'irs_history_v1';
        const LS_DARK = 'irs_dark_v1';

        /* ========= Helpers ========= */
        function showMessage(msg) {
            const modal = document.getElementById('messageModal');
            document.getElementById('messageText').textContent = msg;
            modal.style.display = 'block';
        }
        
        function hideMessage() { 
            document.getElementById('messageModal').style.display = 'none'; 
        }

        /* Dark mode functionality */
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem(LS_DARK, document.body.classList.contains('dark-mode'));
        }

        // Check for saved dark mode preference
        if (localStorage.getItem(LS_DARK) === 'true') {
            document.body.classList.add('dark-mode');
            darkModeToggle.checked = true;
        }

        // Add event listener to toggle
        darkModeToggle.addEventListener('change', toggleDarkMode);

        /* Timer UI */
        function formatTime(seconds) {
            if (seconds < 0) seconds = 0;
            const h = String(Math.floor(seconds/3600)).padStart(2,'0');
            const m = String(Math.floor((seconds%3600)/60)).padStart(2,'0');
            const s = String(seconds%60).padStart(2,'0');
            return `${h}:${m}:${s}`;
        }
        
        function openTimerModal() {
            // prefill from totalTime
            const h = Math.floor(totalTime/3600);
            const m = Math.floor((totalTime%3600)/60);
            const s = totalTime%60;
            hoursInput.value = h>0?h:'';
            minutesInput.value = m>0?m:'';
            secondsInput.value = s>0?s:'';
            timerModal.classList.add('show');
        }
        
        function closeTimerModal() { 
            timerModal.classList.remove('show'); 
        }
        
        timerEl.addEventListener('click', ()=>{ 
            if(!timerRunning) openTimerModal(); 
            else showMessage('Таймер уже запущен'); 
        });
        
        confirmTimerBtn.addEventListener('click', ()=>{
            const h = parseInt(hoursInput.value||0,10);
            const m = parseInt(minutesInput.value||0,10);
            const s = parseInt(secondsInput.value||0,10);
            const total = h*3600 + m*60 + s;
            if(total <= 0){ showMessage('Пожалуйста укажите время больше 0'); return; }
            totalTime = total;
            timerEl.textContent = formatTime(totalTime);
            closeTimerModal();
            // start timer if in test mode
            if(pdfDoc){ startTimer(); timerRunning=true; }
        });
        
        cancelTimerBtn.addEventListener('click', closeTimerModal);

        /* Timer mechanics */
        function startTimer() {
            if(countdown) clearInterval(countdown);
            if(totalTime <= 0){ showMessage('Установите таймер (клик по таймеру)'); return; }
            timerRunning = true;
            timerEl.textContent = formatTime(totalTime);
            countdown = setInterval(()=>{
                totalTime--;
                timerEl.textContent = formatTime(totalTime);
                if(totalTime <= 0){
                    clearInterval(countdown);
                    timerRunning = false;
                    endTestFunc();
                    showMessage('Время закончилось — тест завершён');
                }
            },1000);
        }

        /* ========= PDF loading (render once) =========
           Approach:
           - render PDF pages at base scale 1.0 into canvases inside two separate wrappers
           - implement zoom by applying transform: scale(currentScale) on wrapper (.canvas-wrap)
           - this prevents re-rendering (so highlights/annotations/answers remain intact)
        */
        function clearCanvases() {
            textCanvasWrap.innerHTML = '';
            questionsCanvasWrap.innerHTML = '';
        }
        
        async function loadPDFArrayBuffer(arrayBuffer) {
            currentPDFData = arrayBuffer;
            const loadingTask = pdfjsLib.getDocument({data: arrayBuffer});
            pdfDoc = await loadingTask.promise;
            clearCanvases();
            // render all pages
            for(let p=1;p<=pdfDoc.numPages;p++){
                const page = await pdfDoc.getPage(p);
                const viewport = page.getViewport({scale:1.0});
                // create canvas for text (left)
                const canvasText = document.createElement('canvas');
                canvasText.width = Math.floor(viewport.width);
                canvasText.height = Math.floor(viewport.height);
                canvasText.style.width = canvasText.width + 'px';
                canvasText.style.height = canvasText.height + 'px';
                textCanvasWrap.appendChild(canvasText);
                page.render({canvasContext: canvasText.getContext('2d'), viewport});
                // create canvas for questions (right)
                const canvasQ = document.createElement('canvas');
                canvasQ.width = Math.floor(viewport.width);
                canvasQ.height = Math.floor(viewport.height);
                canvasQ.style.width = canvasQ.width + 'px';
                canvasQ.style.height = canvasQ.height + 'px';
                questionsCanvasWrap.appendChild(canvasQ);
                page.render({canvasContext: canvasQ.getContext('2d'), viewport});
            }
            // show zoom controls and annotation tools
            zoomControls.style.display = 'flex';
            annotationTools.style.display = 'flex';
            controlsBar.style.display = 'flex';
            document.getElementById('startBtn').style.display = 'none';
            // restore saved state
            restoreAll();
            updateZoomUI();
        }

        /* Zoom functions (apply transform to wrappers) */
        function updateZoomUI() {
            zoomValueEl.textContent = Math.round(currentScale*100) + '%';
            textCanvasWrap.style.transform = `scale(${currentScale})`;
            questionsCanvasWrap.style.transform = `scale(${currentScale})`;
            // keep wrappers' transform-origin at top-left
            textCanvasWrap.style.transformOrigin = '0 0';
            questionsCanvasWrap.style.transformOrigin = '0 0';
        }
        
        function zoomIn() {
            if(currentScale + scaleStep <= maxScale) {
                currentScale = +(currentScale + scaleStep).toFixed(2);
                updateZoomUI();
                saveAll(); // positions still valid
            }
        }
        
        function zoomOut() {
            if(currentScale - scaleStep >= minScale) {
                currentScale = +(currentScale - scaleStep).toFixed(2);
                updateZoomUI();
                saveAll();
            }
        }

        /* ========= Annotations / highlights / answers system =========
           - Add highlights by dragging when highlight mode enabled
           - Add notes by click when note mode enabled (textarea)
           - Add answer widget (A/B/C/D) by clicking on right column (questions viewer)
           - Save everything to localStorage as absolute coordinates relative to wrapper at scale=1
        */
        function toRelativePos(pageX, pageY, container) {
            const rect = container.getBoundingClientRect();
            // convert pageX/Y to container local coordinates (taking scroll into account)
            const x = pageX - rect.left + container.scrollLeft;
            const y = pageY - rect.top + container.scrollTop;
            // because we rendered canvases at scale=1 but wrapper may be scaled, convert to base coordinates
            const baseX = x / currentScale;
            const baseY = y / currentScale;
            return {x: Math.round(baseX), y: Math.round(baseY)};
        }

        /* Highlights */
        function enableHighlightingHandlers() {
            // mousedown on canvas-wrap children -> start highlight if in highlight mode
            function mDown(e) {
                if(!isHighlighting) return;
                // only start if clicking on canvas area (inside canvas-wrap)
                if(!e.target.tagName || (e.target.tagName !== 'CANVAS' && !e.target.classList.contains('canvas-wrap'))) return;
                const container = e.currentTarget; // canvas-wrap
                const rel = toRelativePos(e.clientX, e.clientY, container);
                currentHighlight = document.createElement('div');
                currentHighlight.className = 'highlight-area';
                currentHighlight.style.left = rel.x + 'px';
                currentHighlight.style.top = rel.y + 'px';
                currentHighlight.style.width = '0px';
                currentHighlight.style.height = '0px';
                container.appendChild(currentHighlight);
                currentHighlight._start = rel;
            }
            
            function mMove(e) {
                if(!currentHighlight) return;
                const container = e.currentTarget;
                const rel = toRelativePos(e.clientX, e.clientY, container);
                const sx = currentHighlight._start.x;
                const sy = currentHighlight._start.y;
                const left = Math.min(sx, rel.x);
                const top = Math.min(sy, rel.y);
                const w = Math.abs(rel.x - sx);
                const h = Math.abs(rel.y - sy);
                currentHighlight.style.left = left + 'px';
                currentHighlight.style.top = top + 'px';
                currentHighlight.style.width = Math.max(2,w) + 'px';
                currentHighlight.style.height = Math.max(2,h) + 'px';
            }
            
            function mUp(e) {
                if(!currentHighlight) return;
                const container = e.currentTarget;
                // small shapes are ignored
                if(currentHighlight.offsetWidth < 6 || currentHighlight.offsetHeight < 6){
                    currentHighlight.remove();
                    currentHighlight = null;
                    return;
                }
                // store highlight
                highlights.push({
                    containerId: container.id,
                    left: currentHighlight.style.left,
                    top: currentHighlight.style.top,
                    width: currentHighlight.style.width,
                    height: currentHighlight.style.height
                });
                // enable context interaction
                currentHighlight.addEventListener('contextmenu', (ev)=>{ ev.preventDefault(); selectedCtxTarget = currentHighlight; showContextMenu(ev.pageX, ev.pageY); });
                saveAll();
                currentHighlight = null;
            }

            // attach to both wrapper containers
            textCanvasWrap.addEventListener('mousedown', mDown);
            textCanvasWrap.addEventListener('mousemove', mMove);
            textCanvasWrap.addEventListener('mouseup', mUp);
            textCanvasWrap.addEventListener('mouseleave', mUp);
            questionsCanvasWrap.addEventListener('mousedown', mDown);
            questionsCanvasWrap.addEventListener('mousemove', mMove);
            questionsCanvasWrap.addEventListener('mouseup', mUp);
            questionsCanvasWrap.addEventListener('mouseleave', mUp);
        }

        /* Notes (text annotations) */
        function enableNoteHandlers() {
            function onClickAddNote(e) {
                if(!isNoteMode) return;
                if(e.target.tagName !== 'CANVAS') return;
                // container is wrapper
                const container = e.currentTarget;
                const pos = toRelativePos(e.clientX, e.clientY, container);
                const ta = document.createElement('textarea');
                ta.className = 'text-annotation';
                ta.style.left = pos.x + 'px';
                ta.style.top = pos.y + 'px';
                ta.style.width = '220px';
                ta.style.height = '28px';
                container.appendChild(ta);
                ta.focus();
                // events
                ta.addEventListener('blur', ()=>{
                    if(ta.value.trim() === ''){
                        ta.remove();
                        saveAll();
                        return;
                    }
                    annotations.push({
                        containerId: container.id,
                        left: ta.style.left,
                        top: ta.style.top,
                        width: ta.style.width,
                        height: ta.style.height,
                        text: ta.value
                    });
                    ta.addEventListener('contextmenu', (ev)=>{ ev.preventDefault(); selectedCtxTarget = ta; showContextMenu(ev.pageX, ev.pageY); });
                    saveAll();
                });
                ta.addEventListener('input', ()=> saveAll());
            }
            
            textCanvasWrap.addEventListener('click', onClickAddNote);
            questionsCanvasWrap.addEventListener('click', onClickAddNote);
        }

        /* Answers widget on questions area */
        function createAnswerWidget(x, y, container, id) {
            // id optional; if absent create unique id
            const widget = document.createElement('div');
            widget.className = 'answer-widget';
            widget.style.position = 'absolute';
            widget.style.left = x + 'px';
            widget.style.top = y + 'px';
            widget.style.zIndex = 60;
            widget.style.display = 'flex';
            widget.style.gap = '4px';
            widget.style.background = 'rgba(255,255,255,0.9)';
            widget.style.border = '1px solid #e6eefc';
            widget.style.padding = '4px';
            widget.style.borderRadius = '6px';
            widget.style.fontWeight = '700';
            widget.style.fontSize = '13px';
            // choices A-D
            const choices = ['A','B','C','D'];
            choices.forEach(ch=>{
                const b = document.createElement('button');
                b.textContent = ch;
                b.style.padding = '4px 8px';
                b.style.borderRadius = '6px';
                b.style.border = 'none';
                b.style.cursor = 'pointer';
                b.style.background = '#f2f6ff';
                b.addEventListener('click', ()=>{
                    // mark selection visual
                    widget.querySelectorAll('button').forEach(btn=> btn.style.background = '#f2f6ff');
                    b.style.background = '#cfe0ff';
                    // save answer
                    const key = id || ('ans_' + Date.now()+ '_' + Math.random().toString(36).slice(2,8));
                    widget.dataset.answerId = key;
                    answers[key] = {
                        containerId: container.id,
                        x: parseInt(widget.style.left),
                        y: parseInt(widget.style.top),
                        choice: ch
                    };
                    widget.dataset.choice = ch;
                    saveAll();
                });
                widget.appendChild(b);
            });
            // contextmenu on widget
            widget.addEventListener('contextmenu', (ev)=>{
                ev.preventDefault();
                selectedCtxTarget = widget;
                showContextMenu(ev.pageX, ev.pageY);
            });
            return widget;
        }
        
        function enableAnswerCreation() {
            // on right-side canvas wrap click -> create answer widget (only when not in note mode)
            questionsCanvasWrap.addEventListener('dblclick', (e)=>{
                // double click to create answer widget
                if(e.target.tagName !== 'CANVAS' && !e.target.classList.contains('canvas-wrap'))) return;
                const container = e.currentTarget;
                const pos = toRelativePos(e.clientX, e.clientY, container);
                const widget = createAnswerWidget(pos.x, pos.y, container);
                container.appendChild(widget);
                // focus first button (no auto-select)
                saveAll();
            });
        }

        /* Context menu handling */
        function showContextMenu(pageX, pageY) {
            contextMenu.style.left = pageX + 'px';
            contextMenu.style.top = pageY + 'px';
            contextMenu.style.display = 'block';
        }
        
        document.addEventListener('click', ()=>{ 
            contextMenu.style.display = 'none'; 
            selectedCtxTarget = null; 
        });
        
        ctxDelete.addEventListener('click', ()=>{
            if(!selectedCtxTarget) return;
            // find type and remove from arrays + DOM
            if(selectedCtxTarget.classList.contains('highlight-area')){
                // remove highlight entry that matches this element by position
                const left = selectedCtxTarget.style.left, top = selectedCtxTarget.style.top, width = selectedCtxTarget.style.width, height = selectedCtxTarget.style.height;
                highlights = highlights.filter(h => !(h.left===left && h.top===top && h.width===width && h.height===height && h.containerId === selectedCtxTarget.parentElement.id));
                selectedCtxTarget.remove();
                saveAll();
            } else if(selectedCtxTarget.classList && selectedCtxTarget.classList.contains('answer-widget')){
                const id = selectedCtxTarget.dataset.answerId;
                if(id && answers[id]) delete answers[id];
                selectedCtxTarget.remove();
                saveAll();
            } else if(selectedCtxTarget.classList && selectedCtxTarget.classList.contains('text-annotation')){
                // remove matching annotation
                const left = selectedCtxTarget.style.left, top = selectedCtxTarget.style.top, text = selectedCtxTarget.value;
                annotations = annotations.filter(a => !(a.left===left && a.top===top && a.text===text && a.containerId === selectedCtxTarget.parentElement.id));
                selectedCtxTarget.remove();
                saveAll();
            } else {
                // generic removal
                selectedCtxTarget.remove();
                saveAll();
            }
            contextMenu.style.display = 'none';
            selectedCtxTarget = null;
        });

        /* ========= Persistence ========= */
        function saveAll() {
            // save highlights, annotations, answers
            localStorage.setItem(LS_HL, JSON.stringify(highlights));
            localStorage.setItem(LS_ANNOT, JSON.stringify(annotations));
            localStorage.setItem(LS_ANS, JSON.stringify(answers));
            // small history handling
            if(loadedFileName){
                const hist = JSON.parse(localStorage.getItem(LS_HISTORY) || '[]');
                if(!hist.includes(loadedFileName)) hist.push(loadedFileName);
                localStorage.setItem(LS_HISTORY, JSON.stringify(hist));
                refreshHistoryUI();
            }
        }
        
        function restoreAll() {
            // restore highlights
            try{
                const hl = JSON.parse(localStorage.getItem(LS_HL) || '[]');
                highlights = Array.isArray(hl)?hl:[];
                highlights.forEach(h=>{
                    const container = document.getElementById(h.containerId);
                    if(!container) return;
                    const el = document.createElement('div');
                    el.className = 'highlight-area';
                    el.style.left = h.left;
                    el.style.top = h.top;
                    el.style.width = h.width;
                    el.style.height = h.height;
                    // context
                    el.addEventListener('contextmenu', (ev)=>{ ev.preventDefault(); selectedCtxTarget = el; showContextMenu(ev.pageX, ev.pageY); });
                    container.appendChild(el);
                });
            }catch(e){ console.warn('HL restore error', e); }

            // restore annotations
            try{
                const an = JSON.parse(localStorage.getItem(LS_ANNOT) || '[]');
                annotations = Array.isArray(an)?an:[];
                annotations.forEach(a=>{
                    const container = document.getElementById(a.containerId);
                    if(!container) return;
                    const ta = document.createElement('textarea');
                    ta.className = 'text-annotation';
                    ta.style.left = a.left;
                    ta.style.top = a.top;
                    ta.style.width = a.width;
                    ta.style.height = a.height;
                    ta.value = a.text;
                    ta.addEventListener('contextmenu', (ev)=>{ ev.preventDefault(); selectedCtxTarget = ta; showContextMenu(ev.pageX, ev.pageY); });
                    ta.addEventListener('input', ()=> {
                        // update annotations array
                        const idx = annotations.findIndex(an=>an.left===a.left && an.top===a.top && an.containerId === a.containerId && an.text === a.text);
                        if(idx >= 0) annotations[idx].text = ta.value;
                        saveAll();
                    });
                    container.appendChild(ta);
                });
            }catch(e){ console.warn('ANNOT restore error', e); }

            // restore answers
            try{
                const an = JSON.parse(localStorage.getItem(LS_ANS) || '{}');
                answers = an || {};
                Object.keys(answers).forEach(k=>{
                    const v = answers[k];
                    const container = document.getElementById(v.containerId);
                    if(!container) return;
                    const widget = createAnswerWidget(v.x, v.y, container, k);
                    container.appendChild(widget);
                    // apply selected choice visually
                    if(v.choice){
                        widget.dataset.answerId = k;
                        widget.dataset.choice = v.choice;
                        const btns = widget.querySelectorAll('button');
                        btns.forEach(b=>{
                            if(b.textContent === v.choice) b.style.background = '#cfe0ff';
                        });
                    }
                });
            }catch(e){ console.warn('ANS restore error', e); }

            refreshHistoryUI();
        }

        /* History UI */
        function refreshHistoryUI() {
            testHistory.innerHTML = '';
            const hist = JSON.parse(localStorage.getItem(LS_HISTORY) || '[]');
            hist.forEach(h => {
                const li = document.createElement('li');
                li.textContent = h;
                testHistory.appendChild(li);
            });
        }

        /* ========= Modes toggles ========= */
        function toggleHighlightMode() {
            isHighlighting = !isHighlighting;
            highlightToolBtn.classList.toggle('active', isHighlighting);
            if(isHighlighting){ isNoteMode = false; noteToolBtn.classList.remove('active'); }
        }
        
        function toggleNoteMode() {
            isNoteMode = !isNoteMode;
            noteToolBtn.classList.toggle('active', isNoteMode);
            if(isNoteMode){ isHighlighting = false; highlightToolBtn.classList.remove('active'); }
        }

        /* ========= Start / End / Analyze flows ========= */
        function startTest() {
            if(!fileInput.files[0]){ showMessage('Пожалуйста, выберите PDF файл.'); return; }
            const reader = new FileReader();
            reader.onload = function(e) {
                loadedFileName = fileInput.files[0].name || 'Тест';
                loadPDFArrayBuffer(e.target.result);
            };
            reader.readAsArrayBuffer(fileInput.files[0]);
            // hide upload area small
            document.getElementById('uploadSection').style.display = 'none';
            // show pdf area (already visible)
            // show timer small; default 00:00:00 until user sets
            timerEl.style.display = 'block';
            timerEl.textContent = formatTime(totalTime || 0);
        }

        function endTestFunc() {
            // stop timer
            if(countdown) clearInterval(countdown);
            timerRunning = false;
            // hide pdf area (we'll show endTest)
            document.getElementById('pdfArea').style.display = 'none';
            endTestEl.style.display = 'flex';
            // save everything
            saveAll();
        }

        function analyzeTest() {
            // ensure pdf area visible and we restore states
            document.getElementById('pdfArea').style.display = 'flex';
            endTestEl.style.display = 'none';
            // keep everything as is (we did not clear states)
            showMessage('Анализ: все ответы и заметки сохранены и отображаются.');
        }

        /* ========= UI wiring after DOM loaded ========= */
        document.addEventListener('DOMContentLoaded', ()=>{
            // initialize values
            timerEl.textContent = '00:00:00';
            // handlers
            enableHighlightingHandlers();
            enableNoteHandlers();
            enableAnswerCreation();

            // restore any saved scale (if needed)
            const savedDark = localStorage.getItem(LS_DARK);
            if(savedDark === 'true'){ document.body.classList.add('dark-mode'); }

            // context menu hide on resize
            window.addEventListener('resize', ()=> contextMenu.style.display = 'none');

            // context menu target deletion handled above
        });

        /* ========= Save on unload ========= */
        window.addEventListener('beforeunload', ()=>{
            saveAll();
        });

        /* ========= File change quick preview load (optional) ========= */
        fileInput.addEventListener('change', ()=> {
            // optionally auto-start: show start button only
            if(fileInput.files[0]){
                startBtn.style.display = 'inline-block';
            }
        });

        /* expose some functions to window for buttons */
        window.zoomIn = zoomIn;
        window.zoomOut = zoomOut;
        window.startTest = startTest;
        window.endTestFunc = endTestFunc;
        window.analyzeTest = analyzeTest;
        window.toggleHighlightMode = toggleHighlightMode;
        window.toggleNoteMode = toggleNoteMode;
        window.hideMessage = hideMessage;
    </script>
</body>
</html>
